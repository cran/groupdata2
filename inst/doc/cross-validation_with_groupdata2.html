<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1">

<meta name="author" content="Ludvig Renbo Olsen" />

<meta name="date" content="2019-08-05" />

<title>Cross-validation with groupdata2</title>



<style type="text/css">code{white-space: pre;}</style>
<style type="text/css" data-origin="pandoc">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>

<style type="text/css">
  p.abstract{
    text-align: center;
    font-weight: bold;
  }
  div.abstract{
    margin: auto;
    width: 90%;
  }
</style>


<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#header {
text-align: center;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; }  code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>
<style type="text/css">h1 {
font-size:190%;
padding-top:20px;
}
hr {
border-style: solid;
border: none;
border-top: 0.5px solid #777;
margin: 28px 0;
}
img {
margin-top: 20px;
margin-bottom: 20px;
}
p {
padding-bottom:7px;
}
</style>




</head>

<body>




<h1 class="title toc-ignore">Cross-validation with groupdata2</h1>
<h4 class="author">Ludvig Renbo Olsen</h4>
<h4 class="date">2019-08-05</h4>
<div class="abstract">
<p class="abstract">Abstract</p>
<p>This vignette is an introduction to the package groupdata2.<br />
groupdata2 is a set of methods for easy grouping, windowing, folding, partitioning and splitting of data.<br />
We will go through creating balanced partitions for training/test sets and balanced folds for cross-validation.<br />
 <br />
For a more extensive description of groupdata2, please see <a href="description_of_groupdata2.html">Description of groupdata2</a>  <br />
 <br />
Contact author at <a href="mailto:r-pkgs@ludvigolsen.dk" class="email">r-pkgs@ludvigolsen.dk</a>  <br />
 </p>
<hr />
</div>


<div id="TOC">
<ul>
<li><a href="#introduction">Introduction</a><ul>
<li><a href="#groupdata2-functions-in-focus">groupdata2 functions in focus</a></li>
<li><a href="#what-is-cross-validation">What is cross-validation?</a></li>
<li><a href="#why-training-and-test-sets">Why training and test sets?</a></li>
<li><a href="#the-data">The data</a></li>
</ul></li>
<li><a href="#creating-trainingtest-sets">Creating training/test sets</a><ul>
<li><a href="#what-is-leakage">What is leakage?</a></li>
</ul></li>
<li><a href="#creating-folds-for-cross-validation">Creating folds for cross-validation</a></li>
<li><a href="#cross-validation">Cross-validation</a><ul>
<li><a href="#cross-validation-function">Cross-validation function</a></li>
<li><a href="#linear-regression-models">Linear regression models</a></li>
</ul></li>
<li><a href="#outro">Outro</a></li>
</ul>
</div>

<div id="introduction" class="section level1">
<h1>Introduction</h1>
<p>In this vignette, we will train a couple of linear regression models on some data. We will use cross-validation with balanced folds to find the best model, and then test that model on a subset of the original data that we haven’t used for training the model.</p>
<p>Our first task will be to split the dataset into a training set and a test set using <strong>partition</strong>(). Then, we will create folds using the <strong>fold</strong>() function. We will code up a simple cross-validation function and put some models to the test!</p>
<p>While we will be writing our own code for cross-validation, it is recommended to use the <em>cvms</em> package for this functionality, when working with linear or logistic regression models.</p>
<div id="groupdata2-functions-in-focus" class="section level2">
<h2>groupdata2 functions in focus</h2>
<p><strong>partition</strong>() creates (optionally) balanced partitions (e.g. training/test sets) from given group sizes. It can balance partitions on one categorical variable (e.g. diagnosis) and/or one numerical variable (e.g. age). It is also able to keep all datapoints with a shared ID (e.g. participant_id) in the same partition.</p>
<p><strong>fold</strong>() creates (optionally) balanced folds for cross-validation. It can balance folds on one categorical variable (e.g. diagnosis) and/or one numerical variable (e.g. age). It is also able to keep all datapoints with a shared ID (e.g. participant_id) in the same fold. If we want to run <em>repeated cross-validation</em>, it can create multiple unique fold columns at once.</p>
</div>
<div id="what-is-cross-validation" class="section level2">
<h2>What is cross-validation?</h2>
<p>The essence of cross-validation is to test a model against data that it hasn’t been trained on, i.e. estimating out-of-sample error. It is done by first dividing the data into groups called <em>folds</em>.</p>
<p>Say we choose to divide the data into <strong>5</strong> folds. Then, in the first iteration, we <em>train</em> a model on the first four folds and <em>test</em> it on the fifth fold. In the second iteration, we then train on folds 2,3,4,5 and test on fold 1. We continue changing which fold is the test fold until all folds have been test folds (i.e. we train and test 5 times in total). In the end we get the average performance of the models and compare these to other cross-validated models.<br />
The model with the least average error is believed to be the best at predicting unseen data from the same population(s) and thus chosen for further interpretation / use.</p>
<p>This is a great technique, and <strong>fold</strong>() makes it even more powerful.</p>
</div>
<div id="why-training-and-test-sets" class="section level2">
<h2>Why training and test sets?</h2>
<p>Even with cross-validation, we have a risk of overfitting our models to our data. That is, while we get really good predictions for our current data, it won’t generalize to new data that we might gather in the future.</p>
<p>To test if this is the case, we store some of the data and <em>don’t touch</em> it before we feel confident that we have found the best model. Then we use the model to predict the targets / dependent variable in that data. If the results are <strong>much</strong> worse on the test set, it likely means that our model is suffering from overfitting! Then we might go back and adjust the models, until we’re pretty confident again. We might also change the number of folds or run <em>repeated cross-validation</em> instead.<br />
Generally though, <em>we should use the test set as few times as possible</em>, as running this cycle too many times could accidentally find a model that is a good predictor of the specific datapoints in the test set, but not in general.<br />
If the test set results are instead somewhat similar to the cross-validation results, these are the results that we report (possibly along with the cross-validation results).</p>
</div>
<div id="the-data" class="section level2">
<h2>The data</h2>
<p>Let’s say, we have scored 10 participants with either of two diagnoses “a” and “b” on a very interesting task, that you’re free to call ‘<em>the task</em>’.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="co"># Attach some packages</span></a>
<a class="sourceLine" id="cb1-2" data-line-number="2"><span class="kw">library</span>(groupdata2)</a>
<a class="sourceLine" id="cb1-3" data-line-number="3"><span class="kw">library</span>(dplyr)</a>
<a class="sourceLine" id="cb1-4" data-line-number="4"><span class="kw">library</span>(ggplot2)</a>
<a class="sourceLine" id="cb1-5" data-line-number="5"><span class="kw">library</span>(knitr) <span class="co"># kable()</span></a>
<a class="sourceLine" id="cb1-6" data-line-number="6"><span class="kw">library</span>(lmerTest) <span class="co">#lmer()</span></a>
<a class="sourceLine" id="cb1-7" data-line-number="7"><span class="kw">library</span>(broom) <span class="co">#tidy()</span></a>
<a class="sourceLine" id="cb1-8" data-line-number="8"><span class="kw">library</span>(hydroGOF) <span class="co"># rmse()</span></a>
<a class="sourceLine" id="cb1-9" data-line-number="9"></a>
<a class="sourceLine" id="cb1-10" data-line-number="10"></a>
<a class="sourceLine" id="cb1-11" data-line-number="11"><span class="co"># Create data frame</span></a>
<a class="sourceLine" id="cb1-12" data-line-number="12">df &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="st">&quot;participant&quot;</span> =<span class="st"> </span><span class="kw">factor</span>(<span class="kw">as.integer</span>(</a>
<a class="sourceLine" id="cb1-13" data-line-number="13">                                        <span class="kw">rep</span>(<span class="kw">c</span>(<span class="st">'1'</span>,<span class="st">'2'</span>, <span class="st">'3'</span>, <span class="st">'4'</span>, <span class="st">'5'</span>, </a>
<a class="sourceLine" id="cb1-14" data-line-number="14">                                        <span class="st">'6'</span>, <span class="st">'7'</span>, <span class="st">'8'</span>, <span class="st">'9'</span>, <span class="st">'10'</span>), <span class="dv">3</span>))),</a>
<a class="sourceLine" id="cb1-15" data-line-number="15">                <span class="st">&quot;age&quot;</span> =<span class="st"> </span><span class="kw">rep</span>(<span class="kw">c</span>(<span class="dv">20</span>,<span class="dv">23</span>,<span class="dv">27</span>,<span class="dv">21</span>,<span class="dv">32</span>,<span class="dv">31</span>,<span class="dv">43</span>,<span class="dv">21</span>,<span class="dv">34</span>,<span class="dv">32</span>), <span class="dv">3</span>),</a>
<a class="sourceLine" id="cb1-16" data-line-number="16">                <span class="st">&quot;diagnosis&quot;</span> =<span class="st"> </span><span class="kw">rep</span>(<span class="kw">c</span>(<span class="st">'a'</span>, <span class="st">'b'</span>, <span class="st">'a'</span>, <span class="st">'b'</span>, <span class="st">'b'</span>, </a>
<a class="sourceLine" id="cb1-17" data-line-number="17">                                    <span class="st">'a'</span>, <span class="st">'a'</span>, <span class="st">'a'</span>, <span class="st">'b'</span>, <span class="st">'b'</span>), <span class="dv">3</span>),</a>
<a class="sourceLine" id="cb1-18" data-line-number="18">                <span class="st">&quot;score&quot;</span> =<span class="st"> </span><span class="kw">c</span>(<span class="dv">10</span>,<span class="dv">24</span>,<span class="dv">15</span>,<span class="dv">35</span>,<span class="dv">24</span>,<span class="dv">14</span>,<span class="dv">11</span>,<span class="dv">16</span>,<span class="dv">33</span>,<span class="dv">29</span>,  <span class="co"># for 1st session</span></a>
<a class="sourceLine" id="cb1-19" data-line-number="19">                            <span class="dv">24</span>,<span class="dv">40</span>,<span class="dv">30</span>,<span class="dv">50</span>,<span class="dv">54</span>,<span class="dv">25</span>,<span class="dv">35</span>,<span class="dv">32</span>,<span class="dv">53</span>,<span class="dv">55</span>,  <span class="co"># for 2nd session</span></a>
<a class="sourceLine" id="cb1-20" data-line-number="20">                            <span class="dv">45</span>,<span class="dv">67</span>,<span class="dv">40</span>,<span class="dv">78</span>,<span class="dv">62</span>,<span class="dv">30</span>,<span class="dv">41</span>,<span class="dv">44</span>,<span class="dv">66</span>,<span class="dv">81</span>)) <span class="co"># for 3rd session</span></a>
<a class="sourceLine" id="cb1-21" data-line-number="21"></a>
<a class="sourceLine" id="cb1-22" data-line-number="22"><span class="co"># Order by participant</span></a>
<a class="sourceLine" id="cb1-23" data-line-number="23">df &lt;-<span class="st"> </span>df <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">arrange</span>(participant)</a>
<a class="sourceLine" id="cb1-24" data-line-number="24"></a>
<a class="sourceLine" id="cb1-25" data-line-number="25"><span class="co"># Remove index</span></a>
<a class="sourceLine" id="cb1-26" data-line-number="26"><span class="kw">rownames</span>(df) &lt;-<span class="st"> </span><span class="ot">NULL</span></a>
<a class="sourceLine" id="cb1-27" data-line-number="27"></a>
<a class="sourceLine" id="cb1-28" data-line-number="28"><span class="co"># Add session info</span></a>
<a class="sourceLine" id="cb1-29" data-line-number="29">df<span class="op">$</span>session &lt;-<span class="st"> </span><span class="kw">as.integer</span>(<span class="kw">rep</span>(<span class="kw">c</span>(<span class="st">'1'</span>,<span class="st">'2'</span>, <span class="st">'3'</span>), <span class="dv">10</span>))</a>
<a class="sourceLine" id="cb1-30" data-line-number="30"></a>
<a class="sourceLine" id="cb1-31" data-line-number="31"><span class="co"># Show the data frame</span></a>
<a class="sourceLine" id="cb1-32" data-line-number="32"><span class="kw">kable</span>(df, <span class="dt">align =</span> <span class="st">'c'</span>)</a></code></pre></div>
<table>
<thead>
<tr class="header">
<th align="center">participant</th>
<th align="center">age</th>
<th align="center">diagnosis</th>
<th align="center">score</th>
<th align="center">session</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="center">1</td>
<td align="center">20</td>
<td align="center">a</td>
<td align="center">10</td>
<td align="center">1</td>
</tr>
<tr class="even">
<td align="center">1</td>
<td align="center">20</td>
<td align="center">a</td>
<td align="center">24</td>
<td align="center">2</td>
</tr>
<tr class="odd">
<td align="center">1</td>
<td align="center">20</td>
<td align="center">a</td>
<td align="center">45</td>
<td align="center">3</td>
</tr>
<tr class="even">
<td align="center">2</td>
<td align="center">23</td>
<td align="center">b</td>
<td align="center">24</td>
<td align="center">1</td>
</tr>
<tr class="odd">
<td align="center">2</td>
<td align="center">23</td>
<td align="center">b</td>
<td align="center">40</td>
<td align="center">2</td>
</tr>
<tr class="even">
<td align="center">2</td>
<td align="center">23</td>
<td align="center">b</td>
<td align="center">67</td>
<td align="center">3</td>
</tr>
<tr class="odd">
<td align="center">3</td>
<td align="center">27</td>
<td align="center">a</td>
<td align="center">15</td>
<td align="center">1</td>
</tr>
<tr class="even">
<td align="center">3</td>
<td align="center">27</td>
<td align="center">a</td>
<td align="center">30</td>
<td align="center">2</td>
</tr>
<tr class="odd">
<td align="center">3</td>
<td align="center">27</td>
<td align="center">a</td>
<td align="center">40</td>
<td align="center">3</td>
</tr>
<tr class="even">
<td align="center">4</td>
<td align="center">21</td>
<td align="center">b</td>
<td align="center">35</td>
<td align="center">1</td>
</tr>
<tr class="odd">
<td align="center">4</td>
<td align="center">21</td>
<td align="center">b</td>
<td align="center">50</td>
<td align="center">2</td>
</tr>
<tr class="even">
<td align="center">4</td>
<td align="center">21</td>
<td align="center">b</td>
<td align="center">78</td>
<td align="center">3</td>
</tr>
<tr class="odd">
<td align="center">5</td>
<td align="center">32</td>
<td align="center">b</td>
<td align="center">24</td>
<td align="center">1</td>
</tr>
<tr class="even">
<td align="center">5</td>
<td align="center">32</td>
<td align="center">b</td>
<td align="center">54</td>
<td align="center">2</td>
</tr>
<tr class="odd">
<td align="center">5</td>
<td align="center">32</td>
<td align="center">b</td>
<td align="center">62</td>
<td align="center">3</td>
</tr>
<tr class="even">
<td align="center">6</td>
<td align="center">31</td>
<td align="center">a</td>
<td align="center">14</td>
<td align="center">1</td>
</tr>
<tr class="odd">
<td align="center">6</td>
<td align="center">31</td>
<td align="center">a</td>
<td align="center">25</td>
<td align="center">2</td>
</tr>
<tr class="even">
<td align="center">6</td>
<td align="center">31</td>
<td align="center">a</td>
<td align="center">30</td>
<td align="center">3</td>
</tr>
<tr class="odd">
<td align="center">7</td>
<td align="center">43</td>
<td align="center">a</td>
<td align="center">11</td>
<td align="center">1</td>
</tr>
<tr class="even">
<td align="center">7</td>
<td align="center">43</td>
<td align="center">a</td>
<td align="center">35</td>
<td align="center">2</td>
</tr>
<tr class="odd">
<td align="center">7</td>
<td align="center">43</td>
<td align="center">a</td>
<td align="center">41</td>
<td align="center">3</td>
</tr>
<tr class="even">
<td align="center">8</td>
<td align="center">21</td>
<td align="center">a</td>
<td align="center">16</td>
<td align="center">1</td>
</tr>
<tr class="odd">
<td align="center">8</td>
<td align="center">21</td>
<td align="center">a</td>
<td align="center">32</td>
<td align="center">2</td>
</tr>
<tr class="even">
<td align="center">8</td>
<td align="center">21</td>
<td align="center">a</td>
<td align="center">44</td>
<td align="center">3</td>
</tr>
<tr class="odd">
<td align="center">9</td>
<td align="center">34</td>
<td align="center">b</td>
<td align="center">33</td>
<td align="center">1</td>
</tr>
<tr class="even">
<td align="center">9</td>
<td align="center">34</td>
<td align="center">b</td>
<td align="center">53</td>
<td align="center">2</td>
</tr>
<tr class="odd">
<td align="center">9</td>
<td align="center">34</td>
<td align="center">b</td>
<td align="center">66</td>
<td align="center">3</td>
</tr>
<tr class="even">
<td align="center">10</td>
<td align="center">32</td>
<td align="center">b</td>
<td align="center">29</td>
<td align="center">1</td>
</tr>
<tr class="odd">
<td align="center">10</td>
<td align="center">32</td>
<td align="center">b</td>
<td align="center">55</td>
<td align="center">2</td>
</tr>
<tr class="even">
<td align="center">10</td>
<td align="center">32</td>
<td align="center">b</td>
<td align="center">81</td>
<td align="center">3</td>
</tr>
</tbody>
</table>
<p>As we can see, there are 5 participants for each diagnosis, and they all seem to have gotten better at the task throughout the three sessions they went through.</p>
</div>
</div>
<div id="creating-trainingtest-sets" class="section level1">
<h1>Creating training/test sets</h1>
<p>In this step, we will split our data into two subsets called train_set and test_set. The main point will be, that we must avoid leakage between the two sets, before it is of any use to us.</p>
<div id="what-is-leakage" class="section level2">
<h2>What is leakage?</h2>
<p>If we were to split the data randomly, with 80 percent going to the training set, and 20 percent going to the test set, we would likely have some of the participants in both the training set AND the test set. But our motivation for having a test set is that we want to know how well our model predicts new, future participants, not how well it knows the ones it saw during training. Furthermore, if our model is overfitted to those participants, our test set might not warn us of this. With this approach, we could get a really low error on both the test set and the training set even though our model is useless outside of the data, we’re working with.</p>
<p>So, how do we deal with this? In this case, it’s as simple as making sure each participant is only in one of the data sets. We can do this with <strong>partition</strong>() and the <em>id_col</em> argument.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1"></a>
<a class="sourceLine" id="cb2-2" data-line-number="2"><span class="kw">set.seed</span>(<span class="dv">1</span>) <span class="co"># For reproducibility</span></a>
<a class="sourceLine" id="cb2-3" data-line-number="3"></a>
<a class="sourceLine" id="cb2-4" data-line-number="4"><span class="co"># Split data in 20/80 (percentage)</span></a>
<a class="sourceLine" id="cb2-5" data-line-number="5"><span class="kw">partition</span>(df, <span class="dt">p =</span> <span class="fl">0.2</span>, <span class="dt">id_col =</span> <span class="st">&quot;participant&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb2-6" data-line-number="6"><span class="st">  </span>.[<span class="dv">1</span>] <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># See only the test set </span></a>
<a class="sourceLine" id="cb2-7" data-line-number="7"><span class="st">  </span><span class="kw">kable</span>()  <span class="co"># Pretty tables :) </span></a></code></pre></div>
<table class="kable_wrapper">
<tbody>
<tr>
<td>
<table>
<thead>
<tr class="header">
<th></th>
<th align="left">participant</th>
<th align="right">age</th>
<th align="left">diagnosis</th>
<th align="right">score</th>
<th align="right">session</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>13</td>
<td align="left">4</td>
<td align="right">21</td>
<td align="left">b</td>
<td align="right">35</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td>14</td>
<td align="left">4</td>
<td align="right">21</td>
<td align="left">b</td>
<td align="right">50</td>
<td align="right">2</td>
</tr>
<tr class="odd">
<td>15</td>
<td align="left">4</td>
<td align="right">21</td>
<td align="left">b</td>
<td align="right">78</td>
<td align="right">3</td>
</tr>
<tr class="even">
<td>16</td>
<td align="left">5</td>
<td align="right">32</td>
<td align="left">b</td>
<td align="right">24</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td>17</td>
<td align="left">5</td>
<td align="right">32</td>
<td align="left">b</td>
<td align="right">54</td>
<td align="right">2</td>
</tr>
<tr class="even">
<td>18</td>
<td align="left">5</td>
<td align="right">32</td>
<td align="left">b</td>
<td align="right">62</td>
<td align="right">3</td>
</tr>
</tbody>
</table>
</td>
</tr>
</tbody>
</table>
<p>The above shows the test set. It contains 2 participants (10 and 5). They both have all 3 sessions in this subset, meaning they are not in the training set! Perfect!<br />
But ehmm.. if we look at the diagnosis column, they both have the diagnosis ‘b’. If we would like to know how well our future model classifies both of the diagnoses, this won’t do. It would be nicer if we have somewhat the same balance of both diagnoses in both the training set and the test set. This is luckily what the <em>cat_col</em> argument is for.<br />
More specifically (behind the scenes), it first subsets the full dataset by each class in the categorical column. Then, it creates partitions in each subset and merges the partitions in the end. When using both the <em>id_col</em> and <em>cat_col</em> arguments, it first subsets by class, then partitions by the unique values in <em>id_col</em>. This means, that the final partition sizes might not always be exactly as specified, depending on the data. Therefore, it is good practice to look at the distribution of participants, classes, etc. in the final partitions, which we will do after trying out that <em>cat_col</em> argument to get our final test and train sets!</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1"></a>
<a class="sourceLine" id="cb3-2" data-line-number="2"><span class="kw">set.seed</span>(<span class="dv">1</span>) <span class="co"># For reproducibility</span></a>
<a class="sourceLine" id="cb3-3" data-line-number="3"></a>
<a class="sourceLine" id="cb3-4" data-line-number="4"><span class="co"># Split data in 20/80 (percentage)</span></a>
<a class="sourceLine" id="cb3-5" data-line-number="5">parts &lt;-<span class="st"> </span><span class="kw">partition</span>(df, <span class="dt">p =</span> <span class="fl">0.2</span>, <span class="dt">id_col =</span> <span class="st">&quot;participant&quot;</span>, <span class="dt">cat_col =</span> <span class="st">'diagnosis'</span>)</a>
<a class="sourceLine" id="cb3-6" data-line-number="6"></a>
<a class="sourceLine" id="cb3-7" data-line-number="7">test_set &lt;-<span class="st"> </span>parts[[<span class="dv">1</span>]]</a>
<a class="sourceLine" id="cb3-8" data-line-number="8">train_set &lt;-<span class="st"> </span>parts[[<span class="dv">2</span>]]</a>
<a class="sourceLine" id="cb3-9" data-line-number="9"></a>
<a class="sourceLine" id="cb3-10" data-line-number="10"><span class="co"># Show test_set</span></a>
<a class="sourceLine" id="cb3-11" data-line-number="11">test_set <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">kable</span>()</a></code></pre></div>
<table>
<thead>
<tr class="header">
<th align="left">participant</th>
<th align="right">age</th>
<th align="left">diagnosis</th>
<th align="right">score</th>
<th align="right">session</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">1</td>
<td align="right">20</td>
<td align="left">a</td>
<td align="right">10</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left">1</td>
<td align="right">20</td>
<td align="left">a</td>
<td align="right">24</td>
<td align="right">2</td>
</tr>
<tr class="odd">
<td align="left">1</td>
<td align="right">20</td>
<td align="left">a</td>
<td align="right">45</td>
<td align="right">3</td>
</tr>
<tr class="even">
<td align="left">10</td>
<td align="right">32</td>
<td align="left">b</td>
<td align="right">29</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="left">10</td>
<td align="right">32</td>
<td align="left">b</td>
<td align="right">55</td>
<td align="right">2</td>
</tr>
<tr class="even">
<td align="left">10</td>
<td align="right">32</td>
<td align="left">b</td>
<td align="right">81</td>
<td align="right">3</td>
</tr>
</tbody>
</table>
<p>Now, our test set contains 2 participants (8 and 10), and the diagnosis column contains 50 percent a’s and 50 percent b’s. Let’s count the diagnoses in the training set as well.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1">train_set <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb4-2" data-line-number="2"><span class="st">  </span><span class="kw">count</span>(diagnosis) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb4-3" data-line-number="3"><span class="st">  </span><span class="kw">kable</span>(<span class="dt">align=</span><span class="st">'c'</span>)</a></code></pre></div>
<table>
<thead>
<tr class="header">
<th align="left">diagnosis</th>
<th align="left">n</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">a</td>
<td align="left">12</td>
</tr>
<tr class="even">
<td align="left">b</td>
<td align="left">12</td>
</tr>
</tbody>
</table>
<p>There are 12 rows for each diagnosis in the training set. In this case, we know that the rest of the participants are all “fully” in this dataset. But let’s count them anyway, so we will remember to do it in the future.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1">train_set <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb5-2" data-line-number="2"><span class="st">  </span><span class="kw">count</span>(participant) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb5-3" data-line-number="3"><span class="st">  </span><span class="kw">kable</span>(<span class="dt">align=</span><span class="st">'c'</span>)</a></code></pre></div>
<table>
<thead>
<tr class="header">
<th align="left">participant</th>
<th align="left">n</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">2</td>
<td align="left">3</td>
</tr>
<tr class="even">
<td align="left">3</td>
<td align="left">3</td>
</tr>
<tr class="odd">
<td align="left">4</td>
<td align="left">3</td>
</tr>
<tr class="even">
<td align="left">5</td>
<td align="left">3</td>
</tr>
<tr class="odd">
<td align="left">6</td>
<td align="left">3</td>
</tr>
<tr class="even">
<td align="left">7</td>
<td align="left">3</td>
</tr>
<tr class="odd">
<td align="left">8</td>
<td align="left">3</td>
</tr>
<tr class="even">
<td align="left">9</td>
<td align="left">3</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="creating-folds-for-cross-validation" class="section level1">
<h1>Creating folds for cross-validation</h1>
<p>In this section, we will create balanced folds for cross-validation. The thought process resembles that in the previous section. <strong>fold</strong>() basically just creates a number of similarly sized partitions. Where <strong>partition</strong>() returned a list of data frames (this is optional, btw.), <strong>fold</strong>() will return the entire training set with a new column called “.folds”. This will be used directly in the cross-validation function to subset the data on each iteration. Remember, that the folds take shifts at being the cross-validation test set (not to be confused with the test set we created in the previous step).</p>
<p>As we’re basically recreating the training / test set scenario that we discussed previously, we want to avoid leakage between the folds. We would also like somewhat balanced distributions of the diagnoses between the folds, though this depends on the context. Let’s create our balanced folds:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1"><span class="kw">set.seed</span>(<span class="dv">1</span>) <span class="co"># For reproducibility</span></a>
<a class="sourceLine" id="cb6-2" data-line-number="2"></a>
<a class="sourceLine" id="cb6-3" data-line-number="3">train_set &lt;-<span class="st"> </span><span class="kw">fold</span>(train_set, <span class="dt">k =</span> <span class="dv">4</span>, <span class="dt">cat_col =</span> <span class="st">'diagnosis'</span>, <span class="dt">id_col =</span> <span class="st">'participant'</span>)</a>
<a class="sourceLine" id="cb6-4" data-line-number="4"></a>
<a class="sourceLine" id="cb6-5" data-line-number="5"><span class="co"># Order by .folds</span></a>
<a class="sourceLine" id="cb6-6" data-line-number="6">train_set &lt;-<span class="st"> </span>train_set <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">arrange</span>(.folds)</a>
<a class="sourceLine" id="cb6-7" data-line-number="7"></a>
<a class="sourceLine" id="cb6-8" data-line-number="8">train_set <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">kable</span>()</a></code></pre></div>
<table>
<thead>
<tr class="header">
<th align="left">participant</th>
<th align="right">age</th>
<th align="left">diagnosis</th>
<th align="right">score</th>
<th align="right">session</th>
<th align="left">.folds</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">3</td>
<td align="right">27</td>
<td align="left">a</td>
<td align="right">15</td>
<td align="right">1</td>
<td align="left">1</td>
</tr>
<tr class="even">
<td align="left">3</td>
<td align="right">27</td>
<td align="left">a</td>
<td align="right">30</td>
<td align="right">2</td>
<td align="left">1</td>
</tr>
<tr class="odd">
<td align="left">3</td>
<td align="right">27</td>
<td align="left">a</td>
<td align="right">40</td>
<td align="right">3</td>
<td align="left">1</td>
</tr>
<tr class="even">
<td align="left">2</td>
<td align="right">23</td>
<td align="left">b</td>
<td align="right">24</td>
<td align="right">1</td>
<td align="left">1</td>
</tr>
<tr class="odd">
<td align="left">2</td>
<td align="right">23</td>
<td align="left">b</td>
<td align="right">40</td>
<td align="right">2</td>
<td align="left">1</td>
</tr>
<tr class="even">
<td align="left">2</td>
<td align="right">23</td>
<td align="left">b</td>
<td align="right">67</td>
<td align="right">3</td>
<td align="left">1</td>
</tr>
<tr class="odd">
<td align="left">8</td>
<td align="right">21</td>
<td align="left">a</td>
<td align="right">16</td>
<td align="right">1</td>
<td align="left">2</td>
</tr>
<tr class="even">
<td align="left">8</td>
<td align="right">21</td>
<td align="left">a</td>
<td align="right">32</td>
<td align="right">2</td>
<td align="left">2</td>
</tr>
<tr class="odd">
<td align="left">8</td>
<td align="right">21</td>
<td align="left">a</td>
<td align="right">44</td>
<td align="right">3</td>
<td align="left">2</td>
</tr>
<tr class="even">
<td align="left">9</td>
<td align="right">34</td>
<td align="left">b</td>
<td align="right">33</td>
<td align="right">1</td>
<td align="left">2</td>
</tr>
<tr class="odd">
<td align="left">9</td>
<td align="right">34</td>
<td align="left">b</td>
<td align="right">53</td>
<td align="right">2</td>
<td align="left">2</td>
</tr>
<tr class="even">
<td align="left">9</td>
<td align="right">34</td>
<td align="left">b</td>
<td align="right">66</td>
<td align="right">3</td>
<td align="left">2</td>
</tr>
<tr class="odd">
<td align="left">6</td>
<td align="right">31</td>
<td align="left">a</td>
<td align="right">14</td>
<td align="right">1</td>
<td align="left">3</td>
</tr>
<tr class="even">
<td align="left">6</td>
<td align="right">31</td>
<td align="left">a</td>
<td align="right">25</td>
<td align="right">2</td>
<td align="left">3</td>
</tr>
<tr class="odd">
<td align="left">6</td>
<td align="right">31</td>
<td align="left">a</td>
<td align="right">30</td>
<td align="right">3</td>
<td align="left">3</td>
</tr>
<tr class="even">
<td align="left">4</td>
<td align="right">21</td>
<td align="left">b</td>
<td align="right">35</td>
<td align="right">1</td>
<td align="left">3</td>
</tr>
<tr class="odd">
<td align="left">4</td>
<td align="right">21</td>
<td align="left">b</td>
<td align="right">50</td>
<td align="right">2</td>
<td align="left">3</td>
</tr>
<tr class="even">
<td align="left">4</td>
<td align="right">21</td>
<td align="left">b</td>
<td align="right">78</td>
<td align="right">3</td>
<td align="left">3</td>
</tr>
<tr class="odd">
<td align="left">7</td>
<td align="right">43</td>
<td align="left">a</td>
<td align="right">11</td>
<td align="right">1</td>
<td align="left">4</td>
</tr>
<tr class="even">
<td align="left">7</td>
<td align="right">43</td>
<td align="left">a</td>
<td align="right">35</td>
<td align="right">2</td>
<td align="left">4</td>
</tr>
<tr class="odd">
<td align="left">7</td>
<td align="right">43</td>
<td align="left">a</td>
<td align="right">41</td>
<td align="right">3</td>
<td align="left">4</td>
</tr>
<tr class="even">
<td align="left">5</td>
<td align="right">32</td>
<td align="left">b</td>
<td align="right">24</td>
<td align="right">1</td>
<td align="left">4</td>
</tr>
<tr class="odd">
<td align="left">5</td>
<td align="right">32</td>
<td align="left">b</td>
<td align="right">54</td>
<td align="right">2</td>
<td align="left">4</td>
</tr>
<tr class="even">
<td align="left">5</td>
<td align="right">32</td>
<td align="left">b</td>
<td align="right">62</td>
<td align="right">3</td>
<td align="left">4</td>
</tr>
</tbody>
</table>
<p>The training set now contains the “.folds” column. We can count the number of rows for each diagnosis and participant per fold like so:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" data-line-number="1">train_set <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb7-2" data-line-number="2"><span class="st">  </span><span class="kw">count</span>(participant, diagnosis) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb7-3" data-line-number="3"><span class="st">  </span><span class="kw">kable</span>(<span class="dt">align=</span><span class="st">'c'</span>)</a></code></pre></div>
<table>
<thead>
<tr class="header">
<th align="left">.folds</th>
<th align="left">participant</th>
<th align="left">diagnosis</th>
<th align="left">n</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">1</td>
<td align="left">2</td>
<td align="left">b</td>
<td align="left">3</td>
</tr>
<tr class="even">
<td align="left">1</td>
<td align="left">3</td>
<td align="left">a</td>
<td align="left">3</td>
</tr>
<tr class="odd">
<td align="left">2</td>
<td align="left">8</td>
<td align="left">a</td>
<td align="left">3</td>
</tr>
<tr class="even">
<td align="left">2</td>
<td align="left">9</td>
<td align="left">b</td>
<td align="left">3</td>
</tr>
<tr class="odd">
<td align="left">3</td>
<td align="left">4</td>
<td align="left">b</td>
<td align="left">3</td>
</tr>
<tr class="even">
<td align="left">3</td>
<td align="left">6</td>
<td align="left">a</td>
<td align="left">3</td>
</tr>
<tr class="odd">
<td align="left">4</td>
<td align="left">5</td>
<td align="left">b</td>
<td align="left">3</td>
</tr>
<tr class="even">
<td align="left">4</td>
<td align="left">7</td>
<td align="left">a</td>
<td align="left">3</td>
</tr>
</tbody>
</table>
<p>Fold 1 contains participants 2 and 7 with 3 rows each. Participant 2 has the diagnosis ‘b’ and participant 7 has the diagnosis ‘a’. This pattern is the same for all folds. This dataset was created for the purpose of showing these functions, so we should expect real world data to be less perfectly distributed and remember to run some checks of the created folds and partitions. Also be aware, that the maximum number of folds is restricted by the number of participants in the classes, if using the <em>id_col</em> and the <em>cat_col</em> arguments together. Remember, that the function first subsets the dataset by <em>cat_col</em> and then creates groups (folds) from the unique values in <em>id_col</em> in each subset, before merging the subsets. So if you only have 3 participants in one of the classes, this will be the maximum number of folds you can create.</p>
</div>
<div id="cross-validation" class="section level1">
<h1>Cross-validation</h1>
<p>What’s left, you ask? Well, now we get to have fun, training and comparing models using cross-validation! If you just came for partition() and fold(), you can skip this part. Personally, I will move on and walk you (you won’t let me walk alone, will you? pleaase?) through a simple cross-validation function for testing a set of models. The models will be predicting the scores of the participants.</p>
<div id="cross-validation-function" class="section level2">
<h2>Cross-validation function</h2>
<p>We have 4 folds in our training set, so we want to train our models on 3 of the folds and test on the last fold. All the folds should be used as test fold once. While there are often faster alternatives to a for loop, we will use it to illustrate the process. We will create a simple cross-validation function where we can specify the model to test, and whether it has random effects. The performance of the model will be measured with RMSE (Root Mean Square Error).</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" data-line-number="1">crossvalidate &lt;-<span class="st"> </span><span class="cf">function</span>(data, k, model, dependent, <span class="dt">random =</span> <span class="ot">FALSE</span>){</a>
<a class="sourceLine" id="cb8-2" data-line-number="2">  <span class="co"># 'data' is the training set with the &quot;.folds&quot; column</span></a>
<a class="sourceLine" id="cb8-3" data-line-number="3">  <span class="co"># 'k' is the number of folds we have</span></a>
<a class="sourceLine" id="cb8-4" data-line-number="4">  <span class="co"># 'model' is a string describing a linear regression model formula</span></a>
<a class="sourceLine" id="cb8-5" data-line-number="5">  <span class="co"># 'dependent' is a string with the name of the score column we want to predict</span></a>
<a class="sourceLine" id="cb8-6" data-line-number="6">  <span class="co"># 'random' is a logical; do we have random effects in the model?</span></a>
<a class="sourceLine" id="cb8-7" data-line-number="7">  </a>
<a class="sourceLine" id="cb8-8" data-line-number="8">  <span class="co"># Initialize empty list for recording performances</span></a>
<a class="sourceLine" id="cb8-9" data-line-number="9">  performances &lt;-<span class="st"> </span><span class="kw">c</span>()</a>
<a class="sourceLine" id="cb8-10" data-line-number="10">  </a>
<a class="sourceLine" id="cb8-11" data-line-number="11">  <span class="co"># One iteration per fold</span></a>
<a class="sourceLine" id="cb8-12" data-line-number="12">  <span class="cf">for</span> (fold <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>k){</a>
<a class="sourceLine" id="cb8-13" data-line-number="13">    </a>
<a class="sourceLine" id="cb8-14" data-line-number="14">    <span class="co"># Create training set for this iteration</span></a>
<a class="sourceLine" id="cb8-15" data-line-number="15">    <span class="co"># Subset all the datapoints where .folds does not match the current fold</span></a>
<a class="sourceLine" id="cb8-16" data-line-number="16">    training_set &lt;-<span class="st"> </span>data[data<span class="op">$</span>.folds <span class="op">!=</span><span class="st"> </span>fold,]</a>
<a class="sourceLine" id="cb8-17" data-line-number="17">    </a>
<a class="sourceLine" id="cb8-18" data-line-number="18">    <span class="co"># Create test set for this iteration</span></a>
<a class="sourceLine" id="cb8-19" data-line-number="19">    <span class="co"># Subset all the datapoints where .folds matches the current fold</span></a>
<a class="sourceLine" id="cb8-20" data-line-number="20">    testing_set &lt;-<span class="st"> </span>data[data<span class="op">$</span>.folds <span class="op">==</span><span class="st"> </span>fold,]</a>
<a class="sourceLine" id="cb8-21" data-line-number="21">    </a>
<a class="sourceLine" id="cb8-22" data-line-number="22">    <span class="co">## Train model</span></a>
<a class="sourceLine" id="cb8-23" data-line-number="23"></a>
<a class="sourceLine" id="cb8-24" data-line-number="24">    <span class="co"># If there is a random effect,</span></a>
<a class="sourceLine" id="cb8-25" data-line-number="25">    <span class="co"># use lmer() to train model</span></a>
<a class="sourceLine" id="cb8-26" data-line-number="26">    <span class="co"># else use lm()</span></a>
<a class="sourceLine" id="cb8-27" data-line-number="27"></a>
<a class="sourceLine" id="cb8-28" data-line-number="28">    <span class="cf">if</span> (<span class="kw">isTRUE</span>(random)){</a>
<a class="sourceLine" id="cb8-29" data-line-number="29"></a>
<a class="sourceLine" id="cb8-30" data-line-number="30">      <span class="co"># Train linear mixed effects model on training set</span></a>
<a class="sourceLine" id="cb8-31" data-line-number="31">      model &lt;-<span class="st"> </span><span class="kw">lmer</span>(model, training_set, <span class="dt">REML=</span><span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb8-32" data-line-number="32"></a>
<a class="sourceLine" id="cb8-33" data-line-number="33">    } <span class="cf">else</span> {</a>
<a class="sourceLine" id="cb8-34" data-line-number="34"></a>
<a class="sourceLine" id="cb8-35" data-line-number="35">      <span class="co"># Train linear model on training set</span></a>
<a class="sourceLine" id="cb8-36" data-line-number="36">      model &lt;-<span class="st"> </span><span class="kw">lm</span>(model, training_set)</a>
<a class="sourceLine" id="cb8-37" data-line-number="37"></a>
<a class="sourceLine" id="cb8-38" data-line-number="38">    }</a>
<a class="sourceLine" id="cb8-39" data-line-number="39"></a>
<a class="sourceLine" id="cb8-40" data-line-number="40">    <span class="co">## Test model</span></a>
<a class="sourceLine" id="cb8-41" data-line-number="41"></a>
<a class="sourceLine" id="cb8-42" data-line-number="42">    <span class="co"># Predict the dependent variable in the testing_set with the trained model</span></a>
<a class="sourceLine" id="cb8-43" data-line-number="43">    predicted &lt;-<span class="st"> </span><span class="kw">predict</span>(model, testing_set, <span class="dt">allow.new.levels=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb8-44" data-line-number="44"></a>
<a class="sourceLine" id="cb8-45" data-line-number="45">    <span class="co"># Get the Root Mean Square Error between the predicted and the observed</span></a>
<a class="sourceLine" id="cb8-46" data-line-number="46">    RMSE &lt;-<span class="st"> </span><span class="kw">rmse</span>(predicted, testing_set[[dependent]])</a>
<a class="sourceLine" id="cb8-47" data-line-number="47"></a>
<a class="sourceLine" id="cb8-48" data-line-number="48">    <span class="co"># Add the RMSE to the performance list</span></a>
<a class="sourceLine" id="cb8-49" data-line-number="49">    performances[fold] &lt;-<span class="st"> </span>RMSE</a>
<a class="sourceLine" id="cb8-50" data-line-number="50"></a>
<a class="sourceLine" id="cb8-51" data-line-number="51"></a>
<a class="sourceLine" id="cb8-52" data-line-number="52">  }</a>
<a class="sourceLine" id="cb8-53" data-line-number="53"></a>
<a class="sourceLine" id="cb8-54" data-line-number="54">  <span class="co"># Return the mean of the recorded RMSEs</span></a>
<a class="sourceLine" id="cb8-55" data-line-number="55">  <span class="kw">return</span>(<span class="kw">c</span>(<span class="st">'RMSE'</span> =<span class="st"> </span><span class="kw">mean</span>(performances)))</a>
<a class="sourceLine" id="cb8-56" data-line-number="56"></a>
<a class="sourceLine" id="cb8-57" data-line-number="57">}</a></code></pre></div>
</div>
<div id="linear-regression-models" class="section level2">
<h2>Linear regression models</h2>
<p>We could have a hypothesis that people with the diagnosis ‘b’ tend to be better at the experiment. This could be tested by a simple linear model.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" data-line-number="1"><span class="kw">lm</span>(score<span class="op">~</span>diagnosis, df) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb9-2" data-line-number="2"><span class="st">  </span><span class="kw">summary</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb9-3" data-line-number="3"><span class="st">  </span><span class="kw">tidy</span>()</a>
<a class="sourceLine" id="cb9-4" data-line-number="4"><span class="co">#&gt; # A tibble: 2 x 5</span></a>
<a class="sourceLine" id="cb9-5" data-line-number="5"><span class="co">#&gt;   term        estimate std.error statistic     p.value</span></a>
<a class="sourceLine" id="cb9-6" data-line-number="6"><span class="co">#&gt;   &lt;chr&gt;          &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;       &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb9-7" data-line-number="7"><span class="co">#&gt; 1 (Intercept)     27.5      4.07      6.74 0.000000253</span></a>
<a class="sourceLine" id="cb9-8" data-line-number="8"><span class="co">#&gt; 2 diagnosisb      22.6      5.76      3.92 0.000515</span></a></code></pre></div>
<p>The linear model supports the hypothesis, as the average score of participants with diagnosis ‘b’ is larger than that of participants with diagnosis ‘a’, and as this difference is statistically significant, we can reasonably reject the null-hypothesis that there is no difference between the two diagnoses.</p>
<p>To improve our model, we might want to include the information we have about <em>age</em> and <em>sessions</em>. Perhaps, the older participants do better than the younger? And perhaps, participants with the diagnosis ‘b’ are better at learning over time (session)? By including such information in our model, we might be better at predicting the score. We could also use <em>participant</em> as a random effect, to factor out the personal differences.<br />
Let’s list a bunch of possible model formulas that we can then compare with cross-validation. The cross-validation function needs the model to be passed in the format below (a string). Instead of looking at summaries for each model, we will find the best model with cross-validation and only look at the summary for that one. Notice that when we want to compare models, we want to keep the same random effects for all the models, so we are only comparing the combination of fixed effects.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" data-line-number="1">m0 &lt;-<span class="st"> 'score~1+(1|participant)'</span></a>
<a class="sourceLine" id="cb10-2" data-line-number="2">m1 &lt;-<span class="st"> 'score~diagnosis+(1|participant)'</span></a>
<a class="sourceLine" id="cb10-3" data-line-number="3">m2 &lt;-<span class="st"> 'score~diagnosis+age+(1|participant)'</span></a>
<a class="sourceLine" id="cb10-4" data-line-number="4">m3 &lt;-<span class="st"> 'score~diagnosis+session+(1|participant)'</span></a>
<a class="sourceLine" id="cb10-5" data-line-number="5">m4 &lt;-<span class="st"> 'score~diagnosis*session+(1|participant)'</span></a>
<a class="sourceLine" id="cb10-6" data-line-number="6">m5 &lt;-<span class="st"> 'score~diagnosis*session+age+(1|participant)'</span></a></code></pre></div>
<p>Now, let’s test the 6 models. If you get a message saying “<em>boundary (singular) fit</em>”, it’s because the model is too complex for our small dataset. To avoid this message, try removing the random effects from the models.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" data-line-number="1">m0</a>
<a class="sourceLine" id="cb11-2" data-line-number="2"><span class="co">#&gt; [1] &quot;score~1+(1|participant)&quot;</span></a>
<a class="sourceLine" id="cb11-3" data-line-number="3"><span class="kw">crossvalidate</span>(train_set, <span class="dt">k=</span><span class="dv">4</span>, <span class="dt">model=</span>m0, <span class="dt">dependent=</span><span class="st">'score'</span>, <span class="dt">random=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb11-4" data-line-number="4"><span class="co">#&gt;     RMSE </span></a>
<a class="sourceLine" id="cb11-5" data-line-number="5"><span class="co">#&gt; 17.73018</span></a>
<a class="sourceLine" id="cb11-6" data-line-number="6"></a>
<a class="sourceLine" id="cb11-7" data-line-number="7">m1</a>
<a class="sourceLine" id="cb11-8" data-line-number="8"><span class="co">#&gt; [1] &quot;score~diagnosis+(1|participant)&quot;</span></a>
<a class="sourceLine" id="cb11-9" data-line-number="9"><span class="kw">crossvalidate</span>(train_set, <span class="dt">k=</span><span class="dv">4</span>, <span class="dt">model=</span>m1, <span class="dt">dependent=</span><span class="st">'score'</span>, <span class="dt">random=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb11-10" data-line-number="10"><span class="co">#&gt;     RMSE </span></a>
<a class="sourceLine" id="cb11-11" data-line-number="11"><span class="co">#&gt; 14.58244</span></a>
<a class="sourceLine" id="cb11-12" data-line-number="12"></a>
<a class="sourceLine" id="cb11-13" data-line-number="13">m2</a>
<a class="sourceLine" id="cb11-14" data-line-number="14"><span class="co">#&gt; [1] &quot;score~diagnosis+age+(1|participant)&quot;</span></a>
<a class="sourceLine" id="cb11-15" data-line-number="15"><span class="kw">crossvalidate</span>(train_set, <span class="dt">k=</span><span class="dv">4</span>, <span class="dt">model=</span>m2, <span class="dt">dependent=</span><span class="st">'score'</span>, <span class="dt">random=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb11-16" data-line-number="16"><span class="co">#&gt;     RMSE </span></a>
<a class="sourceLine" id="cb11-17" data-line-number="17"><span class="co">#&gt; 14.76457</span></a>
<a class="sourceLine" id="cb11-18" data-line-number="18"></a>
<a class="sourceLine" id="cb11-19" data-line-number="19">m3</a>
<a class="sourceLine" id="cb11-20" data-line-number="20"><span class="co">#&gt; [1] &quot;score~diagnosis+session+(1|participant)&quot;</span></a>
<a class="sourceLine" id="cb11-21" data-line-number="21"><span class="kw">crossvalidate</span>(train_set, <span class="dt">k=</span><span class="dv">4</span>, <span class="dt">model=</span>m3, <span class="dt">dependent=</span><span class="st">'score'</span>, <span class="dt">random=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb11-22" data-line-number="22"><span class="co">#&gt;     RMSE </span></a>
<a class="sourceLine" id="cb11-23" data-line-number="23"><span class="co">#&gt; 6.286664</span></a>
<a class="sourceLine" id="cb11-24" data-line-number="24"></a>
<a class="sourceLine" id="cb11-25" data-line-number="25">m4</a>
<a class="sourceLine" id="cb11-26" data-line-number="26"><span class="co">#&gt; [1] &quot;score~diagnosis*session+(1|participant)&quot;</span></a>
<a class="sourceLine" id="cb11-27" data-line-number="27"><span class="kw">crossvalidate</span>(train_set, <span class="dt">k=</span><span class="dv">4</span>, <span class="dt">model=</span>m4, <span class="dt">dependent=</span><span class="st">'score'</span>, <span class="dt">random=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb11-28" data-line-number="28"><span class="co">#&gt;     RMSE </span></a>
<a class="sourceLine" id="cb11-29" data-line-number="29"><span class="co">#&gt; 5.936489</span></a>
<a class="sourceLine" id="cb11-30" data-line-number="30"></a>
<a class="sourceLine" id="cb11-31" data-line-number="31">m5</a>
<a class="sourceLine" id="cb11-32" data-line-number="32"><span class="co">#&gt; [1] &quot;score~diagnosis*session+age+(1|participant)&quot;</span></a>
<a class="sourceLine" id="cb11-33" data-line-number="33"><span class="kw">crossvalidate</span>(train_set, <span class="dt">k=</span><span class="dv">4</span>, <span class="dt">model=</span>m5, <span class="dt">dependent=</span><span class="st">'score'</span>, <span class="dt">random=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb11-34" data-line-number="34"><span class="co">#&gt;     RMSE </span></a>
<a class="sourceLine" id="cb11-35" data-line-number="35"><span class="co">#&gt; 6.366463</span></a></code></pre></div>
<p>The model m4 has the lowest error on average and so, we assume that it is the best predictor of out-of-sample data. To make sure it doesn’t overfit the data, let’s look at the error for the test set.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" data-line-number="1"><span class="co"># Creating the model for the full training set</span></a>
<a class="sourceLine" id="cb12-2" data-line-number="2">model_m4 &lt;-<span class="st"> </span><span class="kw">lmer</span>(m4, train_set, <span class="dt">REML =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb12-3" data-line-number="3"></a>
<a class="sourceLine" id="cb12-4" data-line-number="4"><span class="co"># Predict the dependent variable in the test_set with the trained model</span></a>
<a class="sourceLine" id="cb12-5" data-line-number="5">predicted &lt;-<span class="st"> </span><span class="kw">predict</span>(model_m4, test_set, <span class="dt">allow.new.levels=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb12-6" data-line-number="6"></a>
<a class="sourceLine" id="cb12-7" data-line-number="7"><span class="co"># Get the Root Mean Square Error between the predicted and the observed</span></a>
<a class="sourceLine" id="cb12-8" data-line-number="8">RMSE &lt;-<span class="st"> </span><span class="kw">rmse</span>(predicted, test_set[[<span class="st">'score'</span>]])</a>
<a class="sourceLine" id="cb12-9" data-line-number="9">RMSE</a>
<a class="sourceLine" id="cb12-10" data-line-number="10"><span class="co">#&gt; [1] 6.609127</span></a></code></pre></div>
<p>6.61 is a bit higher than the cross-validated average, but it’s so close that we’re not afraid of overfitting. Be aware that the scale of the RMSE is dependent on the dependent variable in our dataset, so you might find some models with much higher RMSEs than this one. What matters is the relative difference between models, and that the best model will have the lowest error.</p>
<p>Let’s look at its summary:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" data-line-number="1">model_m4 <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb13-2" data-line-number="2"><span class="st">  </span><span class="kw">summary</span>()</a>
<a class="sourceLine" id="cb13-3" data-line-number="3"><span class="co">#&gt; Linear mixed model fit by maximum likelihood . t-tests use</span></a>
<a class="sourceLine" id="cb13-4" data-line-number="4"><span class="co">#&gt;   Satterthwaite's method [lmerModLmerTest]</span></a>
<a class="sourceLine" id="cb13-5" data-line-number="5"><span class="co">#&gt; Formula: m4</span></a>
<a class="sourceLine" id="cb13-6" data-line-number="6"><span class="co">#&gt;    Data: train_set</span></a>
<a class="sourceLine" id="cb13-7" data-line-number="7"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb13-8" data-line-number="8"><span class="co">#&gt;      AIC      BIC   logLik deviance df.resid </span></a>
<a class="sourceLine" id="cb13-9" data-line-number="9"><span class="co">#&gt;    155.6    162.7    -71.8    143.6       18 </span></a>
<a class="sourceLine" id="cb13-10" data-line-number="10"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb13-11" data-line-number="11"><span class="co">#&gt; Scaled residuals: </span></a>
<a class="sourceLine" id="cb13-12" data-line-number="12"><span class="co">#&gt;      Min       1Q   Median       3Q      Max </span></a>
<a class="sourceLine" id="cb13-13" data-line-number="13"><span class="co">#&gt; -1.80605 -0.65665 -0.01581  0.65609  1.58369 </span></a>
<a class="sourceLine" id="cb13-14" data-line-number="14"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb13-15" data-line-number="15"><span class="co">#&gt; Random effects:</span></a>
<a class="sourceLine" id="cb13-16" data-line-number="16"><span class="co">#&gt;  Groups      Name        Variance Std.Dev.</span></a>
<a class="sourceLine" id="cb13-17" data-line-number="17"><span class="co">#&gt;  participant (Intercept)  6.085   2.467   </span></a>
<a class="sourceLine" id="cb13-18" data-line-number="18"><span class="co">#&gt;  Residual                18.484   4.299   </span></a>
<a class="sourceLine" id="cb13-19" data-line-number="19"><span class="co">#&gt; Number of obs: 24, groups:  participant, 8</span></a>
<a class="sourceLine" id="cb13-20" data-line-number="20"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb13-21" data-line-number="21"><span class="co">#&gt; Fixed effects:</span></a>
<a class="sourceLine" id="cb13-22" data-line-number="22"><span class="co">#&gt;                    Estimate Std. Error     df t value Pr(&gt;|t|)    </span></a>
<a class="sourceLine" id="cb13-23" data-line-number="23"><span class="co">#&gt; (Intercept)           3.000      3.508 23.253   0.855  0.40113    </span></a>
<a class="sourceLine" id="cb13-24" data-line-number="24"><span class="co">#&gt; diagnosisb            6.583      4.961 23.253   1.327  0.19735    </span></a>
<a class="sourceLine" id="cb13-25" data-line-number="25"><span class="co">#&gt; session              12.375      1.520 16.000   8.141 4.42e-07 ***</span></a>
<a class="sourceLine" id="cb13-26" data-line-number="26"><span class="co">#&gt; diagnosisb:session    7.250      2.150 16.000   3.373  0.00388 ** </span></a>
<a class="sourceLine" id="cb13-27" data-line-number="27"><span class="co">#&gt; ---</span></a>
<a class="sourceLine" id="cb13-28" data-line-number="28"><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></a>
<a class="sourceLine" id="cb13-29" data-line-number="29"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb13-30" data-line-number="30"><span class="co">#&gt; Correlation of Fixed Effects:</span></a>
<a class="sourceLine" id="cb13-31" data-line-number="31"><span class="co">#&gt;             (Intr) dgnssb sessin</span></a>
<a class="sourceLine" id="cb13-32" data-line-number="32"><span class="co">#&gt; diagnosisb  -0.707              </span></a>
<a class="sourceLine" id="cb13-33" data-line-number="33"><span class="co">#&gt; session     -0.867  0.613       </span></a>
<a class="sourceLine" id="cb13-34" data-line-number="34"><span class="co">#&gt; dgnssb:sssn  0.613 -0.867 -0.707</span></a></code></pre></div>
<p>In this model, we have a significant interaction between diagnosis and session. The interpretation of this result would be quite different from that of the first model, we tried. Also notice, that the cross-validated m3 and m5 models are so close to the cross-validated m4 model that we can’t be completely sure that it is better than these. The observed differences might as well stem from the randomization in the <strong>partition</strong>() or <strong>fold</strong>() steps. In such a case, we could turn to <em>repeated cross-validation</em>, where we create multiple fold columns (by setting <em>num_fold_cols</em> in <strong>fold</strong>()) and cross-validate them. If the models are still very close, we might consider reporting all three models or at least checking if the interpretations of the three models differ. These things are highly dependent on the context.</p>
<p>When working with linear and logistic regression, the <strong>cvms</strong> package contains functions for (repeated) cross-validation and is specifically designed to work well with groupdata2.</p>
</div>
</div>
<div id="outro" class="section level1">
<h1>Outro</h1>
<p>Well done, you made it to the end of this introduction to groupdata2! If you want to know more about the various methods and arguments, you can read the <a href="description_of_groupdata2.html">Description of groupdata2</a>.<br />
If you have any questions or comments to this vignette (tutorial) or groupdata2, please send them to me at<br />
<a href="mailto:r-pkgs@ludvigolsen.dk" class="email">r-pkgs@ludvigolsen.dk</a>, or open an issue on the github page <a href="https://github.com/LudvigOlsen/groupdata2" class="uri">https://github.com/LudvigOlsen/groupdata2</a> so I can make improvements.</p>
<p>   </p>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
